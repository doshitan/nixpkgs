# This file is autogenerated! Do not edit it yourself, use ../update.py for regeneration.
{ stdenv, fetchgit, arcanist, libphutil, php }:

let
  phabricator-npm = import ./phabricator-npm.nix {};
in
stdenv.mkDerivation rec {
  name = "phabricator-${version}";
  version = "2016-10-03";

  src = fetchgit {
    url = "https://github.com/phacility/phabricator.git";
    rev = "8dbc3f184092578026563b4a2fe9f7356dd15dee";
    sha256 = "02xxmn0vh20rjv59lqf5w66amg34b5mrzw66avnjys6mijacmrbz";
  };

  buildInputs = [ php arcanist libphutil phabricator-npm.package ];

  patches = [ ./conf.patch ];

  installPhase = ''
    mkdir -p $out/libexec
    cp -R . $out/libexec/phabricator
    ln -s ${libphutil}/libexec/libphutil $out/libexec/libphutil
    ln -s ${arcanist}/libexec/arcanist $out/libexec/arcanist
    ln -s ${phabricator-npm.package}/lib/node_modules/phabricator-npm/node_modules $out/libexec/phabricator/support/aphlict/server/node_modules
  '';

  meta = {
    description = "A collection of web applications which help software companies build better software";
    homepage    = "http://phabricator.org";
    license     = stdenv.lib.licenses.asl20;
    platforms   = stdenv.lib.platforms.unix;
  };
}
